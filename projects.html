<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daftar Proyek - Rupaloka Studio</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fa; margin:0; padding:20px; }
    .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    h1 { color: #1a3b8b; margin:0 0 10px 0; }
    h2 { color: #2c5282; margin:0 0 30px 0; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; }
    .logout-btn { background:#1a3b8b; color:white; padding:12px 28px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
    .logout-btn:hover { background:#132d66; }
    #formTambahProyek { 
      display:none; 
      background:#ebf4ff; 
      padding:30px; 
      border-radius:16px; 
      border:3px solid #3b82f6; 
      margin-bottom:40px; 
    }
    input { width:100%; padding:14px; margin:10px 0; border-radius:8px; border:1px solid #ccc; font-size:16px; box-sizing:border-box; }
    #btnTambahProyek { background:#2563eb; color:white; padding:16px; border:none; border-radius:10px; font-weight:bold; font-size:17px; cursor:pointer; width:100%; margin-top:10px; }
    #btnTambahProyek:hover { background:#1d4ed8; }

    .project-item {
      background:white; padding:22px; margin:18px 0; border-radius:14px; 
      box-shadow:0 6px 20px rgba(0,0,0,0.08); border-left:7px solid #2563eb; 
      cursor:pointer; position:relative;
    }
    .project-item:hover { background:#f8faff; transform:translateY(-2px); transition:all 0.2s; }
    .project-name { font-size:1.4em; font-weight:bold; color:#1e293b; }
    .project-info { color:#64748b; font-size:0.95em; }
    .admin-actions { position:absolute; top:18px; right:18px; opacity:0; transition:opacity 0.2s; }
    .project-item:hover .admin-actions { opacity:1; }
    .admin-actions button {
      background:none; border:none; font-size:1.4em; cursor:pointer; margin-left:8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>Rupaloka Studio</h1>
        <h2>Daftar Proyek</h2>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div id="formTambahProyek">
      <h3 style="color:#1e40af; margin-top:0;">Tambah Proyek Baru</h3>
      <input type="text" id="namaProyek" placeholder="Nama Proyek" required />
      <input type="text" id="pemberiKerja" placeholder="Pemberi Kerja" required />
      <input type="number" id="nilaiProyek" placeholder="Nilai Proyek (contoh: 100000000)" required />
      <button id="btnTambahProyek">Tambah Proyek</button>
    </div>

    <div id="projectList">
      <p style="text-align:center; color:#888; padding:50px 0;">Loading proyek...</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBiE0oYuXiPNJKC4p7PtfkFeI0sci3BdgI",
      authDomain: "rupaloka-keuangan.firebaseapp.com",
      projectId: "rupaloka-keuangan",
      storageBucket: "rupaloka-keuangan.firebasestorage.app",
      messagingSenderId: "740474161638",
      appId: "1:740474161638:web:1b1a62ad204085a8226e27"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "index.html";
    if (user.role === "admin") document.getElementById("formTambahProyek").style.display = "block";

    const rupiah = (n) => new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(n);

    // Tambah Proyek
    document.getElementById("btnTambahProyek")?.addEventListener("click", async () => {
      const nama = document.getElementById("namaProyek").value.trim();
      const pemberi = document.getElementById("pemberiKerja").value.trim();
      const nilai = parseInt(document.getElementById("nilaiProyek").value);
      if (!nama || !pemberi || !nilai) return alert("Isi semua kolom!");

      await addDoc(collection(db, "projects"), { namaProyek: nama, pemberiKerja: pemberi, nilaiProyek: nilai, createdAt: new Date() });
      alert("Proyek berhasil ditambahkan!");
      document.getElementById("namaProyek").value = "";
      document.getElementById("pemberiKerja").value = "";
      document.getElementById("nilaiProyek").value = "";
    });

    // Load Proyek
    const list = document.getElementById("projectList");
    const q = query(collection(db, "projects"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snap) => {
      list.innerHTML = "";
      if (snap.empty) {
        list.innerHTML = "<p style='text-align:center; color:#999; padding:60px 0; font-size:18px;'>Belum ada proyek.</p>";
        return;
      }
      snap.forEach((d) => {
        const p = d.data();
        const item = document.createElement("div");
        item.className = "project-item";
        item.onclick = () => location.href = `transactions.html?project=${d.id}`;

        item.innerHTML = `
          <div class="project-name">${p.namaProyek}</div>
          <div class="project-info">${p.pemberiKerja} â€¢ ${rupiah(p.nilaiProyek)}</div>
          ${user.role === "admin" ? `
            <div class="admin-actions">
              <button onclick="event.stopPropagation(); editProyek('${d.id}', '${p.namaProyek}', '${p.pemberiKerja}', ${p.nilaiProyek})" title="Edit">Edit</button>
              <button onclick="event.stopPropagation(); if(confirm('Hapus proyek ini?')) deleteDoc(doc(db,'projects','${d.id}'))" title="Hapus" style="color:#dc2626;">Delete</button>
            </div>
          ` : ""}
        `;
        list.appendChild(item);
      });
    });

    // Edit Proyek (simple prompt)
    window.editProyek = async (id, nama, pemberi, nilai) => {
      const newNama = prompt("Nama Proyek", nama);
      const newPemberi = prompt("Pemberi Kerja", pemberi);
      const newNilai = prompt("Nilai Proyek", nilai);
      if (newNama && newPemberi && newNilai) {
        await updateDoc(doc(db, "projects", id), {
          namaProyek: newNama, pemberiKerja: newPemberi, nilaiProyek: parseInt(newNilai)
        });
        alert("Proyek diperbarui!");
      }
    };

    window.logout = () => { localStorage.clear(); location.href = "index.html"; };
  </script>
</body>
</html>
