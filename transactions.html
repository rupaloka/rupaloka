<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Transaksi Proyek - Rupaloka Studio</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f8fafc; margin:0; padding:20px; }
    .container { max-width: 1000px; margin: auto; background: white; border-radius: 18px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); overflow:hidden; }
    .header { background: linear-gradient(135deg, #1e40af, #3b82f6); color:white; padding:30px; text-align:center; position:relative; }
    .header h1 { margin:0; font-size:2.2em; }
    .header .project-name { font-size:1.6em; margin-top:10px; opacity:0.98; font-weight:600; }
    .back-btn { position:absolute; left:25px; top:25px; background:rgba(255,255,255,0.2); color:white; border:none; padding:12px 18px; border-radius:50px; cursor:pointer; font-weight:bold; }
    .back-btn:hover { background:rgba(255,255,255,0.3); }

    .form-section { padding:30px; background:#f8fafc; border-bottom:1px solid #e2e8f0; }
    .form-grid { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:18px; margin-bottom:20px; align-items:end; }
    @media (max-width:768px) { .form-grid { grid-template-columns:1fr; } }
    input, select { padding:16px; border-radius:12px; border:1px solid #cbd5e1; font-size:16px; background:white; }
    input:focus, select:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,0.15); }
    button#addBtn { background:#10b981; color:white; padding:18px; border:none; border-radius:14px; font-weight:bold; font-size:18px; cursor:pointer; grid-column: span 4; }
    button#addBtn:hover { background:#059669; }

    .list-section { padding:30px; min-height:400px; }
    .transaction-item {
      background:white; padding:18px; margin:14px 0; border-radius:14px; border-left:6px solid;
      box-shadow:0 5px 15px rgba(0,0,0,0.06); cursor:pointer; transition:all 0.2s;
    }
    .transaction-item:hover { transform:translateY(-3px); box-shadow:0 10px 25px rgba(0,0,0,0.12); }
    .transaction-item.debet { border-left-color:#10b981; }
    .transaction-item.kredit { border-left-color:#ef4444; }
    .main-text { font-size:0.98em; font-weight:600; color:#1e293b; line-height:1.5; }
    .sub-text { font-size:0.85em; color:#64748b; margin-top:5px; }
    .creator { font-size:0.78em; color:#94a3b8; margin-top:8px; font-style:italic; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:999; justify-content:center; align-items:center; }
    .modal-content { background:white; padding:35px; border-radius:18px; width:90%; max-width:520px; position:relative; }
    .close { position:absolute; top:18px; right:25px; font-size:28px; cursor:pointer; color:#94a3b8; }
    .modal button { margin:10px 8px; padding:14px 24px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:16px; }
    .btn-update { background:#3b82f6; color:white; }
    .btn-delete { background:#ef4444; color:white; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <button class="back-btn" onclick="history.back()">Back</button>
    <h1>Transaksi Proyek</h1>
    <div class="project-name" id="projectName">Memuat proyek...</div>
  </div>

  <div class="form-section">
    <div class="form-grid">
      <input type="date" id="tanggal" required />
      <select id="tipe" required>
        <option value="">Pilih Tipe</option>
        <option value="debet">Pendapatan (Debet)</option>
        <option value="kredit">Pengeluaran (Kredit)</option>
      </select>
      <select id="kategori" required disabled>
        <option value="">Pilih Kategori</option>
      </select>
      <input type="text" id="keterangan" placeholder="Keterangan (opsional)" />
    </div>
    <div class="form-grid">
      <input type="number" id="jumlah" placeholder="Jumlah (Rp)" required />
      <div></div><div></div>
      <button id="addBtn">+ Tambah Transaksi</button>
    </div>
  </div>

  <div class="list-section">
    <div id="transactionList">
      <p style="text-align:center; color:#94a3b8; padding:80px 0; font-size:18px;">Memuat transaksi...</p>
    </div>
  </div>
</div>

<!-- Modal Edit -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <span class="close" onclick="this.closest('.modal').style.display='none'">X</span>
    <h3>Edit Transaksi</h3>
    <input type="date" id="editTanggal" /><br><br>
    <select id="editTipe">
      <option value="debet">Pendapatan (Debet)</option>
      <option value="kredit">Pengeluaran (Kredit)</option>
    </select><br><br>
    <select id="editKategori"></select><br><br>
    <input type="text" id="editKeterangan" placeholder="Keterangan" /><br><br>
    <input type="number" id="editJumlah" placeholder="Jumlah" /><br><br>
    <button class="btn-update" id="saveEdit">Update</button>
    <button class="btn-delete" id="deleteTransaksi">Hapus</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
  import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBiE0oYuXiPNJKC4p7PtfkFeI0sci3BdgI",
    authDomain: "rupaloka-keuangan.firebaseapp.com",
    projectId: "rupaloka-keuangan",
    storageBucket: "rupaloka-keuangan.firebasestorage.app",
    messagingSenderId: "740474161638",
    appId: "1:740474161638:web:1b1a62ad204085a8226e27"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const user = JSON.parse(localStorage.getItem("user"));
  if (!user) window.location.href = "index.html";

  const urlParams = new URLSearchParams(window.location.search);
  const projectId = urlParams.get('project');
  if (!projectId) window.location.href = "projects.html";

  // Nama Proyek
  getDoc(doc(db, "projects", projectId)).then(snap => {
    if (snap.exists()) document.getElementById("projectName").textContent = snap.data().namaProyek;
  });

  // Kategori
  const kategoriDebet = ["Pembayaran Termin", "Pendapatan lainnya"];
  const kategoriKredit = ["Gaji Tukang", "Material dan Alat", "Operasional", "Pengeluaran lain"];

  document.getElementById("tipe").addEventListener("change", function() {
    const kat = document.getElementById("kategori");
    kat.innerHTML = '<option value="">Pilih Kategori</option>';
    kat.disabled = false;
    const opts = this.value === "debet" ? kategoriDebet : kategoriKredit;
    opts.forEach(o => kat.add(new Option(o, o)));
  });

  // Tambah Transaksi
  document.getElementById("addBtn").onclick = async () => {
    const tanggal = document.getElementById("tanggal").value;
    const tipe = document.getElementById("tipe").value;
    const kategori = document.getElementById("kategori").value;
    const keterangan = document.getElementById("keterangan").value.trim();
    const jumlah = parseInt(document.getElementById("jumlah").value);

    if (!tanggal || !tipe || !kategori || !jumlah) return alert("Lengkapi semua kolom!");

    await addDoc(collection(db, "transactions"), {
      projectId, tanggal, tipe, kategori,
      keterangan: keterangan || "-",
      jumlah,
      createdBy: user.username,
      createdAt: new Date(),
      updatedBy: user.username,
      updatedAt: new Date()
    });

    alert("Transaksi berhasil ditambahkan!");
    document.getElementById("tanggal").value = new Date().toISOString().split('T')[0];
    document.getElementById("tipe").value = "";
    document.getElementById("kategori").disabled = true;
    document.getElementById("kategori").innerHTML = '<option value="">Pilih Kategori</option>';
    document.getElementById("keterangan").value = "";
    document.getElementById("jumlah").value = "";
  };

  // Format Rupiah
  const rupiah = n => new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(n);

  // LOAD TRANSAKSI
  const list = document.getElementById("transactionList");

  let constraints = [where("projectId", "==", projectId)];
  if (user.username === "david") {
    constraints.push(where("createdBy", "==", "david"));
  }

  const q = query(collection(db, "transactions"), ...constraints, orderBy("tanggal", "desc"), orderBy("createdAt", "desc"));

  onSnapshot(q, snap => {
    list.innerHTML = "";
    if (snap.empty) {
      list.innerHTML = "<p style='text-align:center; color:#94a3b8; padding:80px 0; font-size:18px;'>Belum ada transaksi.</p>";
      return;
    }

    snap.forEach(d => {
      const t = d.data();
      const item = document.createElement("div");
      item.className = `transaction-item ${t.tipe}`;
      item.innerHTML = `
        <div class="main-text">${t.tipe === "debet" ? "Debet" : "Kredit"} | ${t.kategori} | ${t.keterangan} | ${rupiah(t.jumlah)}</div>
        <div class="sub-text">${new Date(t.tanggal).toLocaleDateString("id-ID", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
        <div class="creator">Dibuat: ${t.createdBy}${t.updatedBy !== t.createdBy ? ` â€¢ Edit: ${t.updatedBy}` : ""}</div>
      `;

      if (user.role === "admin" || user.username === "fajrin" || user.username === t.createdBy) {
        item.onclick = () => openEditModal(d.id, t);
      }

      list.appendChild(item);
    });
  });

  // Modal Edit & Hapus
  function openEditModal(id, data) {
    const modal = document.getElementById("editModal");
    document.getElementById("editTanggal").value = data.tanggal;
    document.getElementById("editTipe").value = data.tipe;

    const kat = document.getElementById("editKategori");
    kat.innerHTML = "";
    (data.tipe === "debet" ? kategoriDebet : kategoriKredit).forEach(o => {
      kat.add(new Option(o, o, false, o === data.kategori));
    });

    document.getElementById("editKeterangan").value = data.keterangan;
    document.getElementById("editJumlah").value = data.jumlah;
    modal.style.display = "flex";

    document.getElementById("saveEdit").onclick = async () => {
      await updateDoc(doc(db, "transactions", id), {
        tanggal: document.getElementById("editTanggal").value,
        tipe: document.getElementById("editTipe").value,
        kategori: document.getElementById("editKategori").value,
        keterangan: document.getElementById("editKeterangan").value.trim(),
        jumlah: parseInt(document.getElementById("editJumlah").value),
        updatedBy: user.username,
        updatedAt: new Date()
      });
      modal.style.display = "none";
    };

    document.getElementById("deleteTransaksi").onclick = async () => {
      if (user.role === "admin" || user.username === "fajrin") {
        if (confirm("Hapus transaksi ini?")) {
          await deleteDoc(doc(db, "transactions", id));
          modal.style.display = "none";
        }
      } else alert("Hanya Admin & Fajrin yang bisa hapus.");
    };
  }

  // Default tanggal hari ini
  document.getElementById("tanggal").value = new Date().toISOString().split('T')[0];
</script>
</body>
</html>
