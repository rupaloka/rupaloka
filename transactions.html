<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transaksi Proyek</title>
  <style>
    body{font-family:Segoe UI,sans-serif;background:#f1f5f9;margin:0;padding:20px;}
    .container{max-width:1000px;margin:auto;background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden;}
    .header{background:linear-gradient(135deg,#1e40af,#3b82f6);color:#fff;padding:30px;text-align:center;position:relative;}
    .header h1{margin:0;font-size:2.2em;}
    .project-name{font-size:1.6em;margin-top:10px;font-weight:600;}
    .back-btn{position:absolute;left:20px;top:20px;background:rgba(255,255,255,.2);color:#fff;border:none;padding:10px 18px;border-radius:50px;cursor:pointer;}
    .form-section{padding:30px;background:#f8fafc;}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;margin-bottom:20px;align-items:end;}
    @media(max-width:768px){.grid{grid-template-columns:1fr;}}
    input,select{padding:14px;border-radius:12px;border:1px solid #cbd5e1;font-size:16px;}
    input:focus,select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 4px rgba(59,130,246,.2);}
    #addBtn{background:#10b981;color:#fff;padding:16px;border:none;border-radius:12px;font-size:18px;font-weight:bold;cursor:pointer;grid-column:span 4;}
    #addBtn:hover{background:#059669;}
    .list-section{padding:30px;min-height:400px;}
    .item{background:#fff;padding:18px;margin:12px 0;border-radius:12px;border-left:6px solid;box-shadow:0 4px 12px rgba(0,0,0,.08);cursor:pointer;}
    .item.debet{border-left-color:#10b981;}
    .item.kredit{border-left-color:#ef4444;}
    .main{font-weight:600;font-size:1em;color:#1e293b;}
    .sub{color:#64748b;font-size:0.9em;margin-top:4px;}
    .creator{color:#94a3b8;font-size:0.8em;margin-top:6px;font-style:italic;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:999;}
    .modal-content{background:#fff;padding:30px;border-radius:16px;width:90%;max-width:500px;position:relative;}
    .close{position:absolute;top:15px;right:20px;font-size:28px;cursor:pointer;color:#94a3b8;}
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <button class="back-btn" onclick="history.back()">Back</button>
    <h1>Transaksi Proyek</h1>
    <div class="project-name" id="projectName">Loading...</div>
  </div>

  <div class="form-section">
    <div class="grid">
      <input type="date" id="tanggal" required>
      <select id="tipe" required><option value="">Tipe</option><option value="debet">Debet</option><option value="kredit">Kredit</option></select>
      <select id="kategori" required disabled><option value="">Kategori</option></select>
      <input type="text" id="keterangan" placeholder="Keterangan (opsional)">
    </div>
    <div class="grid">
      <input type="number" id="jumlah" placeholder="Jumlah (Rp)" required>
      <div></div><div></div>
      <button id="addBtn">+ Tambah Transaksi</button>
    </div>
  </div>

  <div class="list-section">
    <div id="list">Memuat transaksi...</div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('modal').style.display='none'">X</span>
    <h3>Edit Transaksi</h3>
    <input type="date" id="e_tanggal"><br><br>
    <select id="e_tipe"><option value="debet">Debet</option><option value="kredit">Kredit</option></select><br><br>
    <select id="e_kategori"></select><br><br>
    <input type="text" id="e_keterangan" placeholder="Keterangan"><br><br>
    <input type="number" id="e_jumlah" placeholder="Jumlah"><br><br>
    <button style="background:#3b82f6;color:#fff;padding:12px 20px;border:none;border-radius:8px;" id="save">Update</button>
    <button style="background:#ef4444;color:#fff;padding:12px 20px;border:none;border-radius:8px;" id="hapus">Hapus</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyBiE0oYuXiPNJKC4p7PtfkFeI0sci3BdgI",
    authDomain: "rupaloka-keuangan.firebaseapp.com",
    projectId: "rupaloka-keuangan",
    storageBucket: "rupaloka-keuangan.firebasestorage.app",
    messagingSenderId: "740474161638",
    appId: "1:740474161638:web:1b1a62ad204085a8226e27"
  });

  const db = getFirestore(app);
  const user = JSON.parse(localStorage.getItem("user") || "null");
  if (!user) location.href = "index.html";

  const params = new URLSearchParams(location.search);
  const projectId = params.get("project");
  if (!projectId) location.href = "projects.html";

  // Nama proyek
  getDoc(doc(db, "projects", projectId)).then(s => {
    if (s.exists()) document.getElementById("projectName").textContent = s.data().namaProyek;
  });

  // Kategori
  const debet = ["Pembayaran Termin", "Pendapatan lainnya"];
  const kredit = ["Gaji Tukang", "Material dan Alat", "Operasional", "Pengeluaran lain"];
  document.getElementById("tipe").onchange = () => {
    const kat = document.getElementById("kategori");
    kat.innerHTML = "<option value=''>Kategori</option>";
    kat.disabled = false;
    (document.getElementById("tipe").value === "debet" ? debet : kredit).forEach(o => kat.add(new Option(o,o)));
  };

  // Tambah
  document.getElementById("addBtn").onclick = async () => {
    const t = document.getElementById("tanggal").value;
    const tipe = document.getElementById("tipe").value;
    const kat = document.getElementById("kategori").value;
    const ket = document.getElementById("keterangan").value.trim();
    const jml = parseInt(document.getElementById("jumlah").value);

    if (!t || !tipe || !kat || !jml) return alert("Lengkapi semua field!");

    await addDoc(collection(db, "transactions"), {
      projectId: projectId,
      tanggal: t,
      tipe, kategori: kat,
      keterangan: ket || "-",
      jumlah: jml,
      createdBy: user.username,
      createdAt: new Date(),
      updatedBy: user.username,
      updatedAt: new Date()
    });

    alert("Transaksi berhasil ditambahkan!");
    document.getElementById("jumlah").value = "";
    document.getElementById("keterangan").value = "";
    document.getElementById("tipe").value = "";
    document.getElementById("kategori").innerHTML = "<option value=''>Kategori</option>";
    document.getElementById("kategori").disabled = true;
  };

  // Format rupiah
  const rp = n => new Intl.NumberFormat("id-ID", {style:"currency", currency:"IDR", minimumFractionDigits:0}).format(n);

  // LIST TRANSAKSI — INI YANG PASTI JALAN
  const listDiv = document.getElementById("list");
  const q = query(
    collection(db, "transactions"),
    where("projectId", "==", projectId),
    orderBy("tanggal", "desc"),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, snap => {
    listDiv.innerHTML = "";
    if (snap.empty) {
      listDiv.innerHTML = "<p style='text-align:center;color:#94a3b8;padding:100px 0;font-size:18px;'>Belum ada transaksi</p>";
      return;
    }
    snap.forEach(d => {
      const t = d.data();
      const div = document.createElement("div");
      div.className = `item ${t.tipe}`;
      div.innerHTML = `
        <div class="main">${t.tipe.toUpperCase()} | ${t.kategori} | ${t.keterangan} | ${rp(t.jumlah)}</div>
        <div class="sub">${new Date(t.tanggal).toLocaleDateString("id-ID", {weekday:"long", day:"numeric", month:"long", year:"numeric"})}</div>
        <div class="creator">Dibuat: ${t.createdBy}${t.updatedBy !== t.createdBy ? " • Edit: "+t.updatedBy : ""}</div>
      `;
      if (user.role === "admin" || user.username === "fajrin" || user.username === t.createdBy) {
        div.onclick = () => {
          document.getElementById("e_tanggal").value = t.tanggal;
          document.getElementById("e_tipe").value = t.tipe;
          const ek = document.getElementById("e_kategori"); ek.innerHTML = "";
          (t.tipe === "debet" ? debet : kredit).forEach(o => ek.add(new Option(o,o,false,o===t.kategori)));
          document.getElementById("e_keterangan").value = t.keterangan;
          document.getElementById("e_jumlah").value = t.jumlah;
          document.getElementById("modal").style.display = "flex";

          document.getElementById("save").onclick = async () => {
            await updateDoc(doc(db, "transactions", d.id), {
              tanggal: document.getElementById("e_tanggal").value,
              tipe: document.getElementById("e_tipe").value,
              kategori: document.getElementById("e_kategori").value,
              keterangan: document.getElementById("e_keterangan").value.trim(),
              jumlah: parseInt(document.getElementById("e_jumlah").value),
              updatedBy: user.username,
              updatedAt: new Date()
            });
            document.getElementById("modal").style.display = "none";
          };

          document.getElementById("hapus").onclick = async () => {
            if (user.role === "admin" || user.username === "fajrin") {
              if (confirm("Hapus transaksi ini?")) {
                await deleteDoc(doc(db, "transactions", d.id));
                document.getElementById("modal").style.display = "none";
              }
            }
          };
        };
      }
      listDiv.appendChild(div);
    });
  });

  document.getElementById("tanggal").value = new Date().toISOString().split("T")[0];
</script>
</body>
</html>
