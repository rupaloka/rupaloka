<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Transaksi Proyek - Rupaloka Studio</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f8fafc; margin:0; padding:20px; }
    .container { max-width: 1000px; margin: auto; background: white; border-radius: 18px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); overflow:hidden; }
    .header { background: linear-gradient(135deg, #1e40af, #3b82f6); color:white; padding:25px; text-align:center; }
    .header h1 { margin:0; font-size:2em; }
    .header .project-name { font-size:1.3em; margin-top:8px; opacity:0.95; }
    .back-btn { position:absolute; left:25px; top:25px; background:rgba(255,255,255,0.2); color:white; border:none; padding:10px 16px; border-radius:50px; cursor:pointer; font-weight:bold; }
    .back-btn:hover { background:rgba(255,255,255,0.3); }

    .form-section { padding:30px; background:#f1f5f9; border-bottom:1px solid #e2e8f0; }
    .form-grid { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:15px; margin-bottom:20px; }
    @media (max-width:768px) { .form-grid { grid-template-columns:1fr; } }
    input, select { padding:14px; border-radius:10px; border:1px solid #cbd5e1; font-size:16px; background:white; }
    input:focus, select:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.1); }
    button#addBtn { background:#10b981; color:white; padding:16px; border:none; border-radius:12px; font-weight:bold; font-size:17px; cursor:pointer; width:100%; }
    button#addBtn:hover { background:#059669; }

    .list-section { padding:25px; }
    .transaction-item {
      background:white; padding:16px; margin:12px 0; border-radius:12px; border-left:5px solid;
      box-shadow:0 4px 12px rgba(0,0,0,0.05); cursor:pointer; transition:all 0.2s; position:relative;
    }
    .transaction-item:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.1); }
    .transaction-item.debet { border-left-color:#10b981; }
    .transaction-item.kredit { border-left-color:#ef4444; }
    .main-text { font-size:0.95em; font-weight:600; color:#1e293b; }
    .sub-text { font-size:0.8em; color:#64748b; margin-top:4px; }
    .creator { font-size:0.75em; color:#94a3b8; margin-top:8px; font-style:italic; }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; justify-content:center; align-items:center; }
    .modal-content { background:white; padding:30px; border-radius:16px; width:90%; max-width:500px; position:relative; }
    .close { position:absolute; top:15px; right:20px; font-size:24px; cursor:pointer; color:#94a3b8; }
    .modal button { margin:10px 5px; padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
    .btn-update { background:#3b82f6; color:white; }
    .btn-delete { background:#ef4444; color:white; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <button class="back-btn" onclick="history.back()">Back</button>
    <h1>Transaksi Proyek</h1>
    <div class="project-name" id="projectName">Memuat proyek...</div>
  </div>

  <div class="form-section">
    <div class="form-grid">
      <input type="date" id="tanggal" required />
      <select id="tipe" required>
        <option value="">Pilih Tipe</option>
        <option value="debet">Pendapatan (Debet)</option>
        <option value="kredit">Pengeluaran (Kredit)</option>
      </select>
      <select id="kategori" required disabled>
        <option value="">Pilih Kategori</option>
      </select>
      <input type="text" id="keterangan" placeholder="Keterangan" />
    </div>
    <div class="form-grid">
      <input type="number" id="jumlah" placeholder="Jumlah (Rp)" required />
      <div></div><div></div>
      <button id="addBtn">+ Tambah Transaksi</button>
    </div>
  </div>

  <div class="list-section">
    <div id="transactionList">
      <p style="text-align:center; color:#94a3b8; padding:40px 0;">Memuat transaksi...</p>
    </div>
  </div>
</div>

<!-- Modal Edit -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('editModal').style.display='none'">X</span>
    <h3>Edit Transaksi</h3>
    <input type="date" id="editTanggal" /><br><br>
    <select id="editTipe"></select><br><br>
    <select id="editKategori"></select><br><br>
    <input type="text" id="editKeterangan" placeholder="Keterangan" /><br><br>
    <input type="number" id="editJumlah" placeholder="Jumlah" /><br><br>
    <button class="btn-update" id="saveEdit">Update</button>
    <button class="btn-delete" id="deleteTransaksi">Hapus</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
  import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBiE0oYuXiPNJKC4p7PtfkFeI0sci3BdgI",
    authDomain: "rupaloka-keuangan.firebaseapp.com",
    projectId: "rupaloka-keuangan",
    storageBucket: "rupaloka-keuangan.firebasestorage.app",
    messagingSenderId: "740474161638",
    appId: "1:740474161638:web:1b1a62ad204085a8226e27"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const user = JSON.parse(localStorage.getItem("user"));
  if (!user) window.location.href = "index.html";

  const urlParams = new URLSearchParams(window.location.search);
  const projectId = urlParams.get('project');
  if (!projectId) window.location.href = "projects.html";

  // Kategori
  const kategoriDebet = ["Pembayaran Termin", "Pendapatan lainnya"];
  const kategoriKredit = ["Gaji Tukang", "Material dan Alat", "Operasional", "Pengeluaran lain"];

  const tipeSelect = document.getElementById("tipe");
  const kategoriSelect = document.getElementById("kategori");

  tipeSelect.addEventListener("change", () => {
    kategoriSelect.innerHTML = '<option value="">Pilih Kategori</option>';
    kategoriSelect.disabled = false;
    const options = tipeSelect.value === "debet" ? kategoriDebet : kategoriKredit;
    options.forEach(opt => {
      const o = document.createElement("option");
      o.value = opt; o.textContent = opt;
      kategoriSelect.appendChild(o);
    });
  });

  // Tampilkan nama proyek
  const projectNameEl = document.getElementById("projectName");
  db.collection("projects").doc(projectId).get().then(doc => {
    if (doc.exists) projectNameEl.textContent = doc.data().namaProyek;
  });

  // Tambah transaksi
  document.getElementById("addBtn").addEventListener("click", async () => {
    const tanggal = document.getElementById("tanggal").value;
    const tipe = tipeSelect.value;
    const kategori = kategoriSelect.value;
    const keterangan = document.getElementById("keterangan").value.trim();
    const jumlah = parseInt(document.getElementById("jumlah").value);

    if (!tanggal || !tipe || !kategori || !jumlah) return alert("Lengkapi semua kolom!");

    await addDoc(collection(db, "transactions"), {
      projectId,
      tanggal,
      tipe,
      kategori,
      keterangan: keterangan || "-",
      jumlah,
      createdBy: user.username,
      createdAt: new Date(),
      updatedBy: user.username,
      updatedAt: new Date()
    });

    // Reset form
    document.getElementById("tanggal").value = new Date().toISOString().split('T')[0];
    tipeSelect.value = ""; kategoriSelect.disabled = true; kategoriSelect.innerHTML = '<option value="">Pilih Kategori</option>';
    document.getElementById("keterangan").value = "";
    document.getElementById("jumlah").value = "";
  });

  // Format rupiah
  const rupiah = (n) => new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(n);

  // Load transaksi
  const list = document.getElementById("transactionList");
  let q = query(collection(db, "transactions"), where("projectId", "==", projectId), orderBy("tanggal", "desc"), orderBy("createdAt", "desc"));

  // Jika david → hanya lihat punya sendiri
  if (user.username === "david") {
    q = query(q, where("createdBy", "==", "david"));
  }

  onSnapshot(q, (snap) => {
    list.innerHTML = "";
    if (snap.empty) {
      list.innerHTML = "<p style='text-align:center; color:#94a3b8; padding:50px 0;'>Belum ada transaksi.</p>";
      return;
    }

    snap.forEach(d => {
      const t = d.data();
      const item = document.createElement("div");
      item.className = `transaction-item ${t.tipe}`;
      item.innerHTML = `
        <div class="main-text">${t.tipe === "debet" ? "Debet" : "Kredit"} | ${t.kategori} | ${t.keterangan || "-"} | ${rupiah(t.jumlah)}</div>
        <div class="sub-text">${new Date(t.tanggal).toLocaleDateString("id-ID")}</div>
        <div class="creator">Dibuat: ${t.createdBy} ${t.updatedBy !== t.createdBy ? `• Edit: ${t.updatedBy}` : ""}</div>
      `;

      item.onclick = () => {
        if (user.username === "fajrin" || user.role === "admin" || user.username === t.createdBy) {
          openEditModal(d.id, t);
        }
      };

      list.appendChild(item);
    });
  });

  // Modal Edit
  function openEditModal(id, data) {
    const modal = document.getElementById("editModal");
    document.getElementById("editTanggal").value = data.tanggal;
    document.getElementById("editTipe").innerHTML = `<option value="debet">Pendapatan (Debet)</option><option value="kredit">Pengeluaran (Kredit)</option>`;
    document.getElementById("editTipe").value = data.tipe;

    const editKat = document.getElementById("editKategori");
    editKat.innerHTML = "";
    const opts = data.tipe === "debet" ? kategoriDebet : kategoriKredit;
    opts.forEach(o => {
      const opt = document.createElement("option");
      opt.value = o; opt.textContent = o;
      if (o === data.kategori) opt.selected = true;
      editKat.appendChild(opt);
    });

    document.getElementById("editKeterangan").value = data.keterangan || "";
    document.getElementById("editJumlah").value = data.jumlah;

    modal.style.display = "flex";

    document.getElementById("saveEdit").onclick = async () => {
      await updateDoc(doc(db, "transactions", id), {
        tanggal: document.getElementById("editTanggal").value,
        tipe: document.getElementById("editTipe").value,
        kategori: document.getElementById("editKategori").value,
        keterangan: document.getElementById("editKeterangan").value.trim(),
        jumlah: parseInt(document.getElementById("editJumlah").value),
        updatedBy: user.username,
        updatedAt: new Date()
      });
      modal.style.display = "none";
    };

    document.getElementById("deleteTransaksi").onclick = async () => {
      if (user.role === "admin" || user.username === "fajrin") {
        if (confirm("Hapus transaksi ini?")) {
          await deleteDoc(doc(db, "transactions", id));
          modal.style.display = "none";
        }
      } else {
        alert("Hanya Admin & Fajrin yang bisa hapus.");
      }
    };
  }

  // Set tanggal default hari ini
  document.getElementById("tanggal").value = new Date().toISOString().split('T')[0];
</script>
</body>
</html>
