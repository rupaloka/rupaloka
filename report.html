<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Keuangan Proyek - Rupaloka Studio</title>
  <style>
    body {
   font-family: Arial, sans-serif;
   background: white;
   margin: 40px;
   color: #000;
   line-height: 1.6;
 }
 .container {
   max-width: 800px;
   margin: 0 auto;
   border: 2px solid #000;
   padding: 30px;
 }
 h1, h2 {
   text-align: center;
   margin: 0 0 20px 0;
 }
 h1 { font-size: 24px; }
 h2 { font-size: 18px; color: #333; }
 table {
   width: 100%;
   margin: 15px 0;
   border-collapse: collapse;
 }
 td {
   padding: 6px 0;
   vertical-align: top;
 }
 .label {
   width: 180px;
   font-weight: bold;
 }
 .value {
   text-align: right;
   padding-right: 20px;
 }
 .total {
   font-weight: bold;
   border-top: 2px solid #000;
   padding-top: 8px;
   margin-top: 8px;
 }
 .section {
   margin: 25px 0;
 }
 .history {
   margin-top: 50px;
   max-width: 800px;
   margin-left: auto;
   margin-right: auto;
   font-size: 14px;
 }
 .history h3 {
   color: #d32f2f;
   margin-bottom: 10px;
   text-align: center;
 }
 .trans {
   margin: 6px 0;
   color: #333;
 }
 .kredit { color: #d32f2f; }
 .debet { color: #2e7d32; }
 @media print {
   body { margin: 10px; }
   .no-print { display: none; }
 }
  </style>
</head>
<body>

<div class="container">
  <h1>Laporan Keuangan Proyek</h1>
  <h2>Rupaloka Studio</h2>

  <table>
    <tr><td class="label">Nama Proyek</td><td>: <span id="namaProyek">-</span></td></tr>
    <tr><td class="label">Nama Konsumen</td><td>: <span id="pemberiKerja">-</span></td></tr>
    <tr><td class="label">Nilai Proyek</td><td>: <span id="nilaiProyek">Rp 0</span></td></tr>
  </table>

  <div class="section">
    <strong>Pendapatan :</strong>
    <table>
      <tr><td class="label">Pembayaran Termin</td><td class="value" id="termin">Rp 0</td></tr>
      <tr><td class="label">Pembayaran Lain-lain</td><td class="value" id="lainDebet">Rp 0</td></tr>
      <tr><td class="label">Lain-Lain</td><td class="value" id="lainDebetExtra">Rp 0</td></tr>
      <tr><td class="total">Total Pendapatan</td><td class="value total" id="totalPendapatan">Rp 0</td></tr>
    </table>
  </div>

  <div class="section">
    <strong>Pengeluaran :</strong>
    <table>
      <tr><td class="label">Gaji</td><td class="value" id="gaji">Rp 0</td></tr>
      <tr><td class="label">Material</td><td class="value" id="material">Rp 0</td></tr>
      <tr><td class="label">Operasional</td><td class="value" id="operasional">Rp 0</td></tr>
      <tr><td class="label">Lain-Lain</td><td class="value" id="lainKredit">Rp 0</td></tr>
      <tr><td class="total">Total Pengeluaran</td><td class="value total" id="totalPengeluaran">Rp 0</td></tr>
    </table>
  </div>

  <table style="margin-top: 30px;">
    <tr>
      <td class="label" style="font-size:20px;">Untung/Rugi</td>
      <td class="value" id="untungRugi" style="font-size:20px; font-weight:bold;">Rp 0</td>
    </tr>
  </table>
</div>
<!-- AKHIR KOTAK HITAM -->

<!-- HISTORY DIPINDAH KE SINI (di luar kotak) -->
<div class="history">
  <h3>History Transaksi</h3>
  <div id="historyList"></div>
</div>

<button class="no-print" onclick="window.print()" style="margin:50px auto; display:block; padding:12px 30px; background:#f97316; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
  Cetak / Simpan PDF
</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBiE0oYuXiPNJKC4p7PtfkFeI0sci3BdgI",
    authDomain: "rupaloka-keuangan.firebaseapp.com",
    projectId: "rupaloka-keuangan",
    storageBucket: "rupaloka-keuangan.firebasestorage.app",
    messagingSenderId: "740474161638",
    appId: "1:740474161638:web:1b1a62ad204085a8226e27"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const urlParams = new URLSearchParams(window.location.search);
  const projectId = urlParams.get('project');
  if (!projectId) { alert("Project tidak ditemukan"); window.close(); }

  const rp = (n) => new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(n);

  const projDoc = await getDoc(doc(db, "projects", projectId));
  if (projDoc.exists()) {
    const p = projDoc.data();
    document.getElementById("namaProyek").textContent = p.namaProyek;
    document.getElementById("pemberiKerja").textContent = p.pemberiKerja;
    document.getElementById("nilaiProyek").textContent = rp(p.nilaiProyek);
  }

  const totals = { termin: 0, lainDebet: 0, gaji: 0, material: 0, operasional: 0, lainKredit: 0 };
  const historyList = document.getElementById("historyList");

  const q = query(
    collection(db, "transactions"),
    where("projectId", "==", projectId),
    orderBy("tanggal", "desc"),
    orderBy("createdAt", "desc")
  );

  const snapshot = await getDocs(q);

  snapshot.forEach(d => {
    const t = d.data();
    const date = new Date(t.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: '2-digit' });
    const keterangan = t.keterangan === "-" ? "" : ` | ${t.keterangan}`;
    const line = document.createElement("div");
    line.className = "trans";

    if (t.tipe === "debet") {
      if (t.kategori === "Pembayaran Termin") totals.termin += t.jumlah;
      else if (t.kategori === "Pembayaran Lain") totals.lainDebet += t.jumlah;
      else totals.lainDebet += t.jumlah;

      line.innerHTML = `<span class="debet">Debet</span> | ${date} | ${t.kategori}${keterangan} | ${rp(t.jumlah)}`;
    } else {
      if (t.kategori === "Gaji") totals.gaji += t.jumlah;
      else if (t.kategori === "Material") totals.material += t.jumlah;
      else if (t.kategori === "Operasional") totals.operasional += t.jumlah;
      else totals.lainKredit += t.jumlah;

      line.innerHTML = `<span class="kredit">Kredit</span> | ${date} | ${t.kategori}${keterangan} | ${rp(t.jumlah)}`;
    }
    historyList.appendChild(line);
  });

  document.getElementById("termin").textContent = rp(totals.termin);
  document.getElementById("lainDebet").textContent = rp(totals.lainDebet);
  document.getElementById("lainDebetExtra").textContent = rp(0);

  document.getElementById("gaji").textContent = rp(totals.gaji);
  document.getElementById("material").textContent = rp(totals.material);
  document.getElementById("operasional").textContent = rp(totals.operasional);
  document.getElementById("lainKredit").textContent = rp(totals.lainKredit);

  const totalPendapatan = totals.termin + totals.lainDebet;
  const totalPengeluaran = totals.gaji + totals.material + totals.operasional + totals.lainKredit;
  const untungRugi = totalPendapatan - totalPengeluaran;

  document.getElementById("totalPendapatan").textContent = rp(totalPendapatan);
  document.getElementById("totalPengeluaran").textContent = rp(totalPengeluaran);
  document.getElementById("untungRugi").textContent = rp(untungRugi);
  document.getElementById("untungRugi").style.color = untungRugi >= 0 ? "green" : "red";
</script>
</body>
</html>
